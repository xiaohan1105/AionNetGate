# ç™»å½•å™¨é›†æˆæŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨æ¸¸æˆå¯åŠ¨å™¨ä¸­é›†æˆ AionGate çƒ­æ›´æ–°ç³»ç»Ÿã€‚

---

## ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [UIè®¾è®¡å»ºè®®](#uiè®¾è®¡å»ºè®®)
3. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)
4. [è¿›åº¦æ˜¾ç¤º](#è¿›åº¦æ˜¾ç¤º)
5. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
6. [æµ‹è¯•æ¸…å•](#æµ‹è¯•æ¸…å•)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ¸¸æˆå¯åŠ¨å™¨                              â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ç‰ˆæœ¬æ£€æŸ¥å™¨ â”‚â”€â”€â–¶â”‚  æ›´æ–°ç®¡ç†å™¨  â”‚â”€â”€â–¶â”‚  è¿›åº¦UIç»„ä»¶      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â”‚                 â”‚                    â”‚              â”‚
â”‚        â”‚                 â”‚                    â”‚              â”‚
â”‚        â–¼                 â–¼                    â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              AionGate æ›´æ–° API                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## UIè®¾è®¡å»ºè®®

### 1. æ–°ç”¨æˆ·å®‰è£…ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ® æ¬¢è¿æ¥åˆ°æ°¸æ’ä¹‹å¡”                                            â”‚
â”‚                                                                â”‚
â”‚  è¯·é€‰æ‹©ä¸‹è½½æ–¹å¼ä¸‹è½½å®Œæ•´å®¢æˆ·ç«¯ï¼ˆ14.65 GBï¼‰ï¼š                      â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â­ ç™¾åº¦ç½‘ç›˜ï¼ˆæ¨èï¼‰                    ä¸‹è½½æ¬¡æ•°: 1,523   â”‚ â”‚
â”‚  â”‚  ä¸‹è½½é€Ÿåº¦å¿«ï¼Œæ¨èä¼˜å…ˆä½¿ç”¨                                  â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  æå–ç : abc123    è§£å‹å¯†ç : aion2024                     â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  [ğŸ“¥ ç‚¹å‡»ä¸‹è½½]  [ğŸ“‹ å¤åˆ¶æå–ç ]                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â­ é˜¿é‡Œäº‘ç›˜ï¼ˆæ¨èï¼‰                    ä¸‹è½½æ¬¡æ•°: 892     â”‚ â”‚
â”‚  â”‚  ä¸‹è½½é€Ÿåº¦å¿«ï¼Œæ¨è                                          â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  æå–ç : xyz789    è§£å‹å¯†ç : aion2024                     â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  [ğŸ“¥ ç‚¹å‡»ä¸‹è½½]  [ğŸ“‹ å¤åˆ¶æå–ç ]                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è¿…é›·äº‘ç›˜                              ä¸‹è½½æ¬¡æ•°: 342     â”‚ â”‚
â”‚  â”‚  æ”¯æŒè¿…é›·åŠ é€Ÿä¸‹è½½                                          â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  è§£å‹å¯†ç : aion2024                                       â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  [ğŸ“¥ ç‚¹å‡»ä¸‹è½½]                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  ğŸ’¡ ä¸‹è½½å®Œæˆåï¼Œè§£å‹åˆ°ä»»æ„ç›®å½•ï¼Œå†æ¬¡è¿è¡Œæœ¬å¯åŠ¨å™¨å³å¯ã€‚         â”‚
â”‚                                                                â”‚
â”‚  [â“ ä¸‹è½½æ•™ç¨‹]  [ğŸ’¬ è”ç³»å®¢æœ]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å¢é‡æ›´æ–°ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬ 2.7.0.16                                         â”‚
â”‚                                                                â”‚
â”‚  ã€æ›´æ–°æ—¥å¿—ã€‘                                                   â”‚
â”‚  â”œâ”€ æ–°å¢: å…¨æ–°å‰¯æœ¬ã€Œæ°¸æ’ä¹‹å¡”ã€                                  â”‚
â”‚  â”œâ”€ ä¼˜åŒ–: æå‡æˆ˜æ–—æµç•…åº¦                                        â”‚
â”‚  â””â”€ ä¿®å¤: ä¿®å¤å·²çŸ¥BUG                                          â”‚
â”‚                                                                â”‚
â”‚  æ›´æ–°å¤§å°: 1.75 GB                                             â”‚
â”‚  é¢„è®¡æ—¶é—´: 5åˆ†é’Ÿ                                               â”‚
â”‚                                                                â”‚
â”‚  [ğŸš€ ç«‹å³æ›´æ–°]  [âŒ ç¨åæé†’]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ›´æ–°è¿›åº¦ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ æ­£åœ¨æ›´æ–°... 2.7.0.15 â†’ 2.7.0.16                            â”‚
â”‚                                                                â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 50%             â”‚
â”‚                                                                â”‚
â”‚  æ­£åœ¨ä¸‹è½½æ›´æ–°æ–‡ä»¶...                                            â”‚
â”‚  å½“å‰æ–‡ä»¶: Data/Levels/level1.pak                              â”‚
â”‚  æ–‡ä»¶è¿›åº¦: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 75%           â”‚
â”‚                                                                â”‚
â”‚  å·²å®Œæˆ: 92/184 æ–‡ä»¶                                           â”‚
â”‚  å·²ä¸‹è½½: 939 MB / 1.75 GB                                      â”‚
â”‚  ä¸‹è½½é€Ÿåº¦: 52.5 MB/s                                           â”‚
â”‚  å‰©ä½™æ—¶é—´: çº¦ 2åˆ†30ç§’                                          â”‚
â”‚  P2PåŠ é€Ÿ: 25% (èŠ‚çœCDNæµé‡)                                    â”‚
â”‚                                                                â”‚
â”‚  [â¸ï¸ æš‚åœ]  [âŒ å–æ¶ˆ]                                          â”‚
â”‚                                                                â”‚
â”‚  ğŸ’¡ æç¤º: è¯·å‹¿å…³é—­å¯åŠ¨å™¨ï¼Œæ›´æ–°å®Œæˆåè‡ªåŠ¨å¯åŠ¨æ¸¸æˆ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šåˆå§‹åŒ–é…ç½®

```csharp
public class UpdateConfig
{
    public string ApiBaseUrl { get; set; } = "https://your-gateway.com/api/update";
    public string LocalGamePath { get; set; } = @"D:\Games\Aion";
    public string VersionFile { get; set; } = "version.txt";
    public int MaxConcurrentDownloads { get; set; } = 8;
    public int RetryCount { get; set; } = 3;
    public bool EnableP2P { get; set; } = true;
}
```

### æ­¥éª¤2ï¼šå®ç°ç‰ˆæœ¬æ£€æŸ¥å™¨

```csharp
public class VersionChecker
{
    private readonly UpdateConfig _config;
    private readonly HttpClient _httpClient;

    public VersionChecker(UpdateConfig config)
    {
        _config = config;
        _httpClient = new HttpClient
        {
            BaseAddress = new Uri(config.ApiBaseUrl)
        };
    }

    public async Task<UpdateCheckResponse> CheckForUpdateAsync()
    {
        // è¯»å–æœ¬åœ°ç‰ˆæœ¬å·
        var localVersion = GetLocalVersion();

        // è¯·æ±‚æœåŠ¡å™¨æ£€æŸ¥æ›´æ–°
        var request = new
        {
            client_version = localVersion,
            channel_code = "official",
            hardware_id = GetHardwareId()
        };

        var response = await _httpClient.PostAsJsonAsync("/check", request);
        response.EnsureSuccessStatusCode();

        return await response.Content.ReadFromJsonAsync<UpdateCheckResponse>();
    }

    private string GetLocalVersion()
    {
        var versionFilePath = Path.Combine(_config.LocalGamePath, _config.VersionFile);

        if (!File.Exists(versionFilePath))
            return "0.0.0.0"; // é¦–æ¬¡å®‰è£…

        return File.ReadAllText(versionFilePath).Trim();
    }

    private string GetHardwareId()
    {
        // ç”Ÿæˆç¡¬ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºç»Ÿè®¡ï¼‰
        var cpuId = GetCpuId();
        var diskId = GetDiskSerial();

        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(
            Encoding.UTF8.GetBytes($"{cpuId}{diskId}")
        );

        return Convert.ToHexString(hash);
    }
}
```

### æ­¥éª¤3ï¼šå®ç°æ›´æ–°ç®¡ç†å™¨

```csharp
public class UpdateManager
{
    private readonly UpdateConfig _config;
    private readonly HttpClient _httpClient;
    private long _updateLogId;

    public event Action<LauncherUpdateProgress> ProgressChanged;

    public UpdateManager(UpdateConfig config)
    {
        _config = config;
        _httpClient = new HttpClient
        {
            BaseAddress = new Uri(config.ApiBaseUrl)
        };
    }

    public async Task<bool> ExecuteUpdateAsync(
        UpdateCheckResponse updateInfo,
        CancellationToken cancellationToken = default)
    {
        if (!updateInfo.NeedsUpdate)
            return true;

        if (updateInfo.NeedsFullClient)
        {
            // æ˜¾ç¤ºç½‘ç›˜ä¸‹è½½ç•Œé¢
            ShowFullClientDownloadUI(updateInfo.FullPackageLinks);
            return false; // ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨ä¸‹è½½å®Œæ•´åŒ…
        }

        try
        {
            // è·å–ç‰ˆæœ¬æ¸…å•
            var manifest = await GetVersionManifestAsync(
                updateInfo.LatestVersion,
                updateInfo.CurrentVersion
            );

            // è®°å½•æ›´æ–°å¼€å§‹
            _updateLogId = await StartUpdateLoggingAsync(
                updateInfo.CurrentVersion,
                updateInfo.LatestVersion,
                manifest
            );

            // ä¸‹è½½æ–‡ä»¶
            await DownloadFilesAsync(manifest, cancellationToken);

            // æ›´æ–°ç‰ˆæœ¬å·
            SaveLocalVersion(updateInfo.LatestVersion);

            // ä¸ŠæŠ¥å®Œæˆ
            await ReportProgressAsync(
                manifest.Files.Count,
                manifest.TotalSize,
                UpdateStatus.Completed
            );

            return true;
        }
        catch (Exception ex)
        {
            // ä¸ŠæŠ¥å¤±è´¥
            await ReportProgressAsync(
                0,
                0,
                UpdateStatus.Failed,
                ex.Message
            );

            throw;
        }
    }

    private async Task<VersionManifestResponse> GetVersionManifestAsync(
        string toVersion,
        string fromVersion)
    {
        var url = $"/manifest/{toVersion}?fromVersion={fromVersion}";
        var response = await _httpClient.GetAsync(url);
        response.EnsureSuccessStatusCode();

        return await response.Content.ReadFromJsonAsync<VersionManifestResponse>();
    }

    private async Task<long> StartUpdateLoggingAsync(
        string fromVersion,
        string toVersion,
        VersionManifestResponse manifest)
    {
        var request = new
        {
            from_version = fromVersion,
            to_version = toVersion,
            total_files = manifest.FileCount,
            total_size = manifest.TotalSize,
            use_p2p = _config.EnableP2P
        };

        var response = await _httpClient.PostAsJsonAsync("/start", request);
        response.EnsureSuccessStatusCode();

        var result = await response.Content.ReadFromJsonAsync<UpdateStartResponse>();
        return result.LogId;
    }

    private async Task DownloadFilesAsync(
        VersionManifestResponse manifest,
        CancellationToken cancellationToken)
    {
        // æŒ‰ä¼˜å…ˆçº§æ’åº
        var files = manifest.Files
            .OrderByDescending(f => f.DownloadPriority)
            .ThenBy(f => f.FileSize)
            .ToList();

        var downloadedFiles = 0;
        var downloadedSize = 0L;
        var startTime = DateTime.UtcNow;

        // å¹¶å‘ä¸‹è½½ï¼ˆ8ä¸ªçº¿ç¨‹ï¼‰
        var semaphore = new SemaphoreSlim(_config.MaxConcurrentDownloads);
        var tasks = files.Select(async file =>
        {
            await semaphore.WaitAsync(cancellationToken);

            try
            {
                var localPath = Path.Combine(_config.LocalGamePath, file.FilePath);

                // åˆ›å»ºç›®å½•
                Directory.CreateDirectory(Path.GetDirectoryName(localPath));

                // ä¸‹è½½æ–‡ä»¶
                await DownloadFileAsync(file.CdnUrl, localPath, file.FileSize, cancellationToken);

                // æ ¡éªŒæ–‡ä»¶
                await VerifyFileAsync(localPath, file.FileHash, file.FileCrc32);

                // æ›´æ–°è¿›åº¦
                Interlocked.Increment(ref downloadedFiles);
                Interlocked.Add(ref downloadedSize, file.FileSize);

                var elapsed = (DateTime.UtcNow - startTime).TotalSeconds;
                var speed = downloadedSize / 1048576.0 / elapsed; // MB/s
                var remaining = (manifest.TotalSize - downloadedSize) / speed; // ç§’

                var progress = new LauncherUpdateProgress
                {
                    Stage = UpdateStage.DownloadingFiles,
                    CurrentFile = file.FilePath,
                    CurrentFileProgress = 100,
                    TotalFiles = files.Count,
                    CompletedFiles = downloadedFiles,
                    OverallProgress = (int)(downloadedSize * 100 / manifest.TotalSize),
                    TotalBytes = manifest.TotalSize,
                    DownloadedBytes = downloadedSize,
                    DownloadSpeed = (long)(speed * 1048576),
                    RemainingSeconds = (int)remaining
                };

                ProgressChanged?.Invoke(progress);

                // æ¯5ä¸ªæ–‡ä»¶ä¸ŠæŠ¥ä¸€æ¬¡è¿›åº¦
                if (downloadedFiles % 5 == 0)
                {
                    await ReportProgressAsync(
                        downloadedFiles,
                        downloadedSize,
                        UpdateStatus.InProgress,
                        downloadSpeed: speed
                    );
                }
            }
            finally
            {
                semaphore.Release();
            }
        });

        await Task.WhenAll(tasks);
    }

    private async Task DownloadFileAsync(
        string url,
        string localPath,
        long fileSize,
        CancellationToken cancellationToken)
    {
        using var client = new HttpClient();

        for (int retry = 0; retry < _config.RetryCount; retry++)
        {
            try
            {
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰éƒ¨åˆ†ä¸‹è½½
                var existingLength = 0L;
                if (File.Exists(localPath))
                {
                    existingLength = new FileInfo(localPath).Length;
                }

                // æ–­ç‚¹ç»­ä¼ 
                if (existingLength > 0 && existingLength < fileSize)
                {
                    var request = new HttpRequestMessage(HttpMethod.Get, url);
                    request.Headers.Range = new System.Net.Http.Headers.RangeHeaderValue(existingLength, null);

                    using var response = await client.SendAsync(request, HttpCompletionOption.ResponseHeadersRead, cancellationToken);
                    response.EnsureSuccessStatusCode();

                    using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
                    using var fileStream = new FileStream(localPath, FileMode.Append, FileAccess.Write, FileShare.None);

                    await stream.CopyToAsync(fileStream, cancellationToken);
                }
                else
                {
                    // å…¨æ–°ä¸‹è½½
                    using var response = await client.GetAsync(url, HttpCompletionOption.ResponseHeadersRead, cancellationToken);
                    response.EnsureSuccessStatusCode();

                    using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
                    using var fileStream = new FileStream(localPath, FileMode.Create, FileAccess.Write, FileShare.None);

                    await stream.CopyToAsync(fileStream, cancellationToken);
                }

                return; // æˆåŠŸ
            }
            catch (Exception ex) when (retry < _config.RetryCount - 1)
            {
                // é‡è¯•
                await Task.Delay(1000 * (retry + 1), cancellationToken);
            }
        }
    }

    private async Task VerifyFileAsync(string filePath, string expectedHash, string expectedCrc32)
    {
        using var stream = File.OpenRead(filePath);

        // è®¡ç®—SHA256
        using var sha256 = SHA256.Create();
        var hash = await sha256.ComputeHashAsync(stream);
        var hashStr = "sha256:" + Convert.ToHexString(hash).ToLowerInvariant();

        if (hashStr != expectedHash)
        {
            throw new InvalidDataException($"æ–‡ä»¶æ ¡éªŒå¤±è´¥: {filePath}");
        }

        // è®¡ç®—CRC32
        stream.Position = 0;
        var crc32 = new Crc32();
        var buffer = new byte[81920];
        int bytesRead;
        while ((bytesRead = await stream.ReadAsync(buffer)) > 0)
        {
            crc32.Append(buffer.AsSpan(0, bytesRead));
        }

        var crc32Str = Convert.ToHexString(crc32.GetCurrentHash()).ToLowerInvariant();

        if (crc32Str != expectedCrc32)
        {
            throw new InvalidDataException($"CRC32æ ¡éªŒå¤±è´¥: {filePath}");
        }
    }

    private async Task ReportProgressAsync(
        int downloadedFiles,
        long downloadedSize,
        UpdateStatus status,
        string errorMessage = null,
        double? downloadSpeed = null)
    {
        var request = new
        {
            log_id = _updateLogId,
            downloaded_files = downloadedFiles,
            downloaded_size = downloadedSize,
            status = (byte)status,
            download_speed = downloadSpeed,
            error_message = errorMessage
        };

        await _httpClient.PostAsJsonAsync("/progress", request);
    }

    private void SaveLocalVersion(string version)
    {
        var versionFilePath = Path.Combine(_config.LocalGamePath, _config.VersionFile);
        File.WriteAllText(versionFilePath, version);
    }
}

public enum UpdateStatus : byte
{
    InProgress = 0,
    Completed = 1,
    Failed = 2,
    Cancelled = 3
}
```

### æ­¥éª¤4ï¼šUIç»‘å®š

```csharp
public partial class LauncherWindow : Window
{
    private readonly VersionChecker _versionChecker;
    private readonly UpdateManager _updateManager;
    private CancellationTokenSource _updateCts;

    public LauncherWindow()
    {
        InitializeComponent();

        var config = new UpdateConfig
        {
            ApiBaseUrl = "https://your-gateway.com/api/update",
            LocalGamePath = @"D:\Games\Aion"
        };

        _versionChecker = new VersionChecker(config);
        _updateManager = new UpdateManager(config);

        // è®¢é˜…è¿›åº¦äº‹ä»¶
        _updateManager.ProgressChanged += OnUpdateProgressChanged;

        Loaded += LauncherWindow_Loaded;
    }

    private async void LauncherWindow_Loaded(object sender, RoutedEventArgs e)
    {
        try
        {
            // æ£€æŸ¥æ›´æ–°
            var updateInfo = await _versionChecker.CheckForUpdateAsync();

            if (!updateInfo.NeedsUpdate)
            {
                // æ— éœ€æ›´æ–°ï¼Œå¯åŠ¨æ¸¸æˆ
                StartGame();
                return;
            }

            if (updateInfo.NeedsFullClient)
            {
                // æ˜¾ç¤ºå®Œæ•´åŒ…ä¸‹è½½ç•Œé¢
                ShowFullClientDownloadPage(updateInfo.FullPackageLinks);
                return;
            }

            // æ˜¾ç¤ºæ›´æ–°ç¡®è®¤å¯¹è¯æ¡†
            var dialogResult = MessageBox.Show(
                $"å‘ç°æ–°ç‰ˆæœ¬ {updateInfo.LatestVersion}\n\n" +
                $"æ›´æ–°å¤§å°: {updateInfo.DownloadSizeText}\n" +
                $"é¢„è®¡æ—¶é—´: {updateInfo.EstimatedTime / 60}åˆ†é’Ÿ\n\n" +
                $"{updateInfo.Changelog}\n\n" +
                $"æ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ",
                "å‘ç°æ›´æ–°",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question
            );

            if (dialogResult == MessageBoxResult.Yes)
            {
                // æ˜¾ç¤ºè¿›åº¦ç•Œé¢
                ShowUpdateProgressPage();

                // æ‰§è¡Œæ›´æ–°
                _updateCts = new CancellationTokenSource();
                var success = await _updateManager.ExecuteUpdateAsync(updateInfo, _updateCts.Token);

                if (success)
                {
                    MessageBox.Show("æ›´æ–°å®Œæˆï¼", "æˆåŠŸ", MessageBoxButton.OK, MessageBoxImage.Information);
                    StartGame();
                }
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"æ›´æ–°å¤±è´¥: {ex.Message}", "é”™è¯¯", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private void OnUpdateProgressChanged(LauncherUpdateProgress progress)
    {
        // åœ¨UIçº¿ç¨‹æ›´æ–°è¿›åº¦
        Dispatcher.Invoke(() =>
        {
            TxtStageName.Text = progress.StageName;
            TxtCurrentFile.Text = progress.CurrentFile ?? "";
            ProgressBarOverall.Value = progress.OverallProgress;
            ProgressBarCurrentFile.Value = progress.CurrentFileProgress;
            TxtFilesProgress.Text = $"{progress.CompletedFiles}/{progress.TotalFiles} æ–‡ä»¶";
            TxtSizeProgress.Text = $"{FormatBytes(progress.DownloadedBytes)} / {FormatBytes(progress.TotalBytes)}";
            TxtDownloadSpeed.Text = progress.DownloadSpeedText;
            TxtRemainingTime.Text = $"å‰©ä½™æ—¶é—´: {progress.RemainingTimeText}";
        });
    }

    private void BtnPause_Click(object sender, RoutedEventArgs e)
    {
        // TODO: å®ç°æš‚åœåŠŸèƒ½
    }

    private void BtnCancel_Click(object sender, RoutedEventArgs e)
    {
        _updateCts?.Cancel();
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double size = bytes;
        int order = 0;

        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }

        return $"{size:F2} {sizes[order]}";
    }
}
```

---

## è¿›åº¦æ˜¾ç¤º

ä½¿ç”¨ `LauncherUpdateProgress` ç±»è·Ÿè¸ªæ‰€æœ‰è¿›åº¦ä¿¡æ¯ï¼š

```csharp
public class LauncherUpdateProgress
{
    // æ›´æ–°é˜¶æ®µ
    public UpdateStage Stage { get; set; }
    public string StageName => GetStageName(Stage);

    // å½“å‰æ–‡ä»¶
    public string CurrentFile { get; set; }
    public int CurrentFileProgress { get; set; } // 0-100

    // æ€»è¿›åº¦
    public int TotalFiles { get; set; }
    public int CompletedFiles { get; set; }
    public int OverallProgress { get; set; } // 0-100

    // å¤§å°ä¿¡æ¯
    public long TotalBytes { get; set; }
    public long DownloadedBytes { get; set; }

    // é€Ÿåº¦ä¿¡æ¯
    public long DownloadSpeed { get; set; }
    public string DownloadSpeedText => FormatSpeed(DownloadSpeed);

    // æ—¶é—´ä¿¡æ¯
    public int RemainingSeconds { get; set; }
    public string RemainingTimeText => FormatTime(RemainingSeconds);

    // P2Pä¿¡æ¯
    public int P2PRatio { get; set; } // 0-100

    // æ§åˆ¶
    public bool CanCancel { get; set; } = true;
    public bool CanPause { get; set; } = true;
    public bool IsPaused { get; set; }
}

public enum UpdateStage
{
    Preparing,
    CheckingVersion,
    DownloadingManifest,
    ComparingFiles,
    DownloadingFiles,
    ExtractingFiles,
    VerifyingFiles,
    ApplyingPatch,
    CleaningUp,
    Completed,
    Failed
}
```

---

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠå¤„ç†

```csharp
try
{
    await _updateManager.ExecuteUpdateAsync(updateInfo);
}
catch (HttpRequestException ex)
{
    // ç½‘ç»œé”™è¯¯
    MessageBox.Show(
        "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•",
        "é”™è¯¯",
        MessageBoxButton.OK,
        MessageBoxImage.Error
    );
}
catch (InvalidDataException ex)
{
    // æ–‡ä»¶æ ¡éªŒå¤±è´¥
    MessageBox.Show(
        "æ–‡ä»¶æ ¡éªŒå¤±è´¥ï¼Œè¯·é‡æ–°ä¸‹è½½",
        "é”™è¯¯",
        MessageBoxButton.OK,
        MessageBoxImage.Error
    );
}
catch (OperationCanceledException)
{
    // ç”¨æˆ·å–æ¶ˆ
    MessageBox.Show(
        "æ›´æ–°å·²å–æ¶ˆ",
        "æç¤º",
        MessageBoxButton.OK,
        MessageBoxImage.Information
    );
}
catch (Exception ex)
{
    // æœªçŸ¥é”™è¯¯
    MessageBox.Show(
        $"æ›´æ–°å¤±è´¥: {ex.Message}\n\nè¯·è”ç³»å®¢æœ",
        "é”™è¯¯",
        MessageBoxButton.OK,
        MessageBoxImage.Error
    );
}
```

---

## æµ‹è¯•æ¸…å•

- [ ] **æ–°ç”¨æˆ·é¦–æ¬¡å®‰è£…**
  - [ ] æ˜¾ç¤ºç½‘ç›˜ä¸‹è½½é“¾æ¥
  - [ ] ç‚¹å‡»é“¾æ¥æ­£ç¡®è·³è½¬
  - [ ] æå–ç å’Œè§£å‹å¯†ç æ­£ç¡®æ˜¾ç¤º
  - [ ] ä¸‹è½½æ¬¡æ•°æ­£ç¡®ç»Ÿè®¡

- [ ] **è€ç”¨æˆ·å¢é‡æ›´æ–°**
  - [ ] æ­£ç¡®æ£€æµ‹ç‰ˆæœ¬å·®å¼‚
  - [ ] æ¸…å•ä¸‹è½½æˆåŠŸ
  - [ ] æ–‡ä»¶å¹¶å‘ä¸‹è½½ï¼ˆ8çº¿ç¨‹ï¼‰
  - [ ] è¿›åº¦å®æ—¶æ›´æ–°
  - [ ] Hashæ ¡éªŒé€šè¿‡
  - [ ] ç‰ˆæœ¬å·æ­£ç¡®æ›´æ–°

- [ ] **æ–­ç‚¹ç»­ä¼ **
  - [ ] ä¸­é€”ä¸­æ–­åå¯ç»§ç»­
  - [ ] å·²ä¸‹è½½çš„æ–‡ä»¶ä¸é‡å¤ä¸‹è½½

- [ ] **é”™è¯¯æ¢å¤**
  - [ ] ç½‘ç»œä¸­æ–­è‡ªåŠ¨é‡è¯•
  - [ ] æ ¡éªŒå¤±è´¥é‡æ–°ä¸‹è½½
  - [ ] æœ€å¤šé‡è¯•3æ¬¡

- [ ] **ç”¨æˆ·ä½“éªŒ**
  - [ ] è¿›åº¦æ¡æµç•…æ›´æ–°
  - [ ] é€Ÿåº¦æ˜¾ç¤ºå‡†ç¡®
  - [ ] å‰©ä½™æ—¶é—´ä¼°ç®—å‡†ç¡®
  - [ ] å¯æš‚åœ/å–æ¶ˆ

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†CDN URLè¿‡æœŸï¼Ÿ

**A**: CDN URLæœ‰æ•ˆæœŸ1å°æ—¶ã€‚å¦‚æœä¸‹è½½è¶…è¿‡1å°æ—¶ï¼Œéœ€è¦é‡æ–°è¯·æ±‚æ¸…å•è·å–æ–°çš„URLã€‚

```csharp
private async Task<string> GetFreshCdnUrlAsync(string filePath, string version)
{
    var manifest = await GetVersionManifestAsync(version, null);
    var file = manifest.Files.FirstOrDefault(f => f.FilePath == filePath);
    return file?.CdnUrl;
}
```

### Q2: å¦‚ä½•ä¼˜åŒ–ä¸‹è½½é€Ÿåº¦ï¼Ÿ

**A**:
1. å¹¶å‘ä¸‹è½½8ä¸ªæ–‡ä»¶
2. å¯ç”¨P2Påˆ†æµ
3. ä½¿ç”¨æœ€è¿‘çš„CDNèŠ‚ç‚¹
4. æŒ‰ä¼˜å…ˆçº§ä¸‹è½½ï¼Œæ ¸å¿ƒæ–‡ä»¶ä¼˜å…ˆ

### Q3: å¦‚ä½•å‡å°‘å†…å­˜å ç”¨ï¼Ÿ

**A**: ä½¿ç”¨æµå¼ä¸‹è½½ï¼Œä¸è¦ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜ã€‚

```csharp
await using var stream = await response.Content.ReadAsStreamAsync();
await using var fileStream = new FileStream(localPath, FileMode.Create);
await stream.CopyToAsync(fileStream);
```

### Q4: å¦‚ä½•å®ç°æš‚åœåŠŸèƒ½ï¼Ÿ

**A**: ä½¿ç”¨ `CancellationToken` å’Œæ–­ç‚¹ç»­ä¼ ç»“åˆï¼š

```csharp
// æš‚åœ
_updateCts?.Cancel();

// ç»§ç»­ï¼ˆé‡æ–°å¼€å§‹ï¼Œä¼šè‡ªåŠ¨æ–­ç‚¹ç»­ä¼ ï¼‰
_updateCts = new CancellationTokenSource();
await _updateManager.ExecuteUpdateAsync(updateInfo, _updateCts.Token);
```

---

## ç¤ºä¾‹é¡¹ç›®

å®Œæ•´ç¤ºä¾‹ä»£ç è¯·å‚è€ƒï¼š
- C# WPFç¤ºä¾‹: `examples/launcher-wpf/`
- C# WinFormsç¤ºä¾‹: `examples/launcher-winforms/`

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ [APIæ–‡æ¡£](./UPDATE_API.md)
2. æŸ¥çœ‹ [README](../README.md)
3. æäº¤ [Issue](https://github.com/xiaohan1105/AionNetGate/issues)
