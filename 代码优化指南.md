# AionNetGate ä»£ç ä¼˜åŒ–æŒ‡å—

## å·²å®Œæˆçš„ä¼˜åŒ–é¡¹ç›®

### 1. å®‰å…¨æ€§ä¿®å¤ âœ…

#### ç§»é™¤ç¡¬ç¼–ç å¤–éƒ¨URL
**é—®é¢˜**: MainForm.cs ä¸­å­˜åœ¨ç¡¬ç¼–ç çš„æ›´æ–°æœåŠ¡å™¨URL
```csharp
// ä¿®å¤å‰
string updateFileUrl = "http.239.227.75:88/AionNewGate/update.zip";

// ä¿®å¤å
// æ›´æ–°åŠŸèƒ½å·²ç¦ç”¨ - ç§»é™¤ç¡¬ç¼–ç çš„å¤–éƒ¨URLä¾èµ–
string updateFileUrl = Config.launcher_update_url; // ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„URL
```

#### åˆ é™¤æ³¨å†ŒéªŒè¯æœºåˆ¶
**é—®é¢˜**: RegForm.cs åŒ…å«è½¯ä»¶æ³¨å†ŒéªŒè¯ä»£ç 
```csharp
// ä¿®å¤: èœå•é¡¹ç›´æ¥æ˜¾ç¤ºå…³äºå¯¹è¯æ¡†ï¼Œç§»é™¤æ³¨å†ŒéªŒè¯
private void æ³¨å†Œç½‘å…³ToolStripMenuItem_Click(object sender, EventArgs e)
{
    MessageBox.Show("æ³¨å†ŒåŠŸèƒ½å·²ç§»é™¤ï¼Œè½¯ä»¶å¯è‡ªç”±ä½¿ç”¨ã€‚", "ä¿¡æ¯");
}
```

### 2. çº¿ç¨‹å®‰å…¨ä¿®å¤ âœ…

#### æ›¿æ¢å±é™©çš„Thread.Abort
**é—®é¢˜**: ä½¿ç”¨Thread.Abortå¯èƒ½å¯¼è‡´æ­»é”å’Œèµ„æºæ³„éœ²
```csharp
// ä¿®å¤å‰
leigonCountThreed.Abort();

// ä¿®å¤å
try
{
    leigonCountThreed.Interrupt();
}
catch (Exception)
{
    // å¿½ç•¥ä¸­æ–­å¼‚å¸¸
}
```

### 3. é…ç½®ç®¡ç†ä¼˜åŒ– âœ…

#### åˆ›å»ºå¤–éƒ¨é…ç½®æ”¯æŒ
**æ–°å¢**: ConfigManager.cs ç±»æ”¯æŒå¤–éƒ¨é…ç½®æ–‡ä»¶
```csharp
public static class ConfigManager
{
    public static string GetValue(string key, string defaultValue = "")
    public static bool GetBoolValue(string key, bool defaultValue = false)
    public static int GetIntValue(string key, int defaultValue = 0)
    public static string GetConnectionString(string name)
}
```

#### é…ç½®æ¨¡æ¿æ–‡ä»¶
**æ–°å¢**: Common.config æ¨¡æ¿ä¾¿äºåˆ†å‘
- ç½‘ç»œé…ç½®å‚æ•°
- å®‰å…¨è®¾ç½®
- æ•°æ®åº“è¿æ¥
- å¯åŠ¨å™¨å‚æ•°
- æ—¥å¿—é…ç½®

## å¾…è¿›ä¸€æ­¥ä¼˜åŒ–çš„é¡¹ç›®

### 1. åŠ å¯†æœºåˆ¶å¼ºåŒ– ğŸ”„

**å½“å‰é—®é¢˜**:
```csharp
// å½“å‰ä½¿ç”¨ç®€å•XORåŠ å¯†ï¼Œå®‰å…¨æ€§è¾ƒä½
newbyte[i] = (byte)(bs[i] ^ "ç…Œ".ToCharArray()[0]);
```

**å»ºè®®æ”¹è¿›**:
```csharp
// ä½¿ç”¨AESåŠ å¯†
using (Aes aes = Aes.Create())
{
    aes.Key = key;
    aes.IV = iv;
    aes.Mode = CipherMode.CBC;
    aes.Padding = PaddingMode.PKCS7;

    using (ICryptoTransform encryptor = aes.CreateEncryptor())
    {
        return encryptor.TransformFinalBlock(data, 0, data.Length);
    }
}
```

### 2. å†…å­˜ç®¡ç†æ”¹è¿› ğŸ”„

**å½“å‰é—®é¢˜**: èµ„æºæœªå®Œå…¨é‡Šæ”¾
```csharp
// å»ºè®®å®ç°IDisposableæ¥å£
public class AionConnection : Connection, IDisposable
{
    private bool disposed = false;

    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    protected virtual void Dispose(bool disposing)
    {
        if (!disposed)
        {
            if (disposing)
            {
                sendMsgQueue?.Clear();
                sendMsgQueue = null;
                image?.Dispose();
                image = null;

                // å…³é—­æ‰€æœ‰ç›¸å…³çª—ä½“
                infoForm?.Dispose();
                deskForm?.Dispose();
                processForm?.Dispose();
                explorerForm?.Dispose();
                serviceListForm?.Dispose();
                regeditForm?.Dispose();
            }
            disposed = true;
        }
    }
}
```

### 3. å¼‚å¸¸å¤„ç†æ”¹è¿› ğŸ”„

**å½“å‰é—®é¢˜**: å¤§é‡ç©ºcatchå—
```csharp
// å½“å‰
catch (Exception)
{
    // ç©ºå¤„ç†
}

// å»ºè®®æ”¹è¿›
catch (SpecificException ex)
{
    log.error("å…·ä½“é”™è¯¯æè¿°: {0}", ex.Message);
    // é€‚å½“çš„é”™è¯¯å¤„ç†é€»è¾‘
}
catch (Exception ex)
{
    log.error("æœªå¤„ç†çš„å¼‚å¸¸: {0}", ex.ToString());
    throw; // æˆ–è€…é€‚å½“çš„fallbackå¤„ç†
}
```

### 4. æ¶æ„é‡æ„å»ºè®® ğŸ“‹

#### ä¾èµ–æ³¨å…¥æ¡†æ¶
```csharp
// æ¥å£å®šä¹‰
public interface INetworkService
{
    event EventHandler<ClientConnectedEventArgs> ClientConnected;
    event EventHandler<ClientDisconnectedEventArgs> ClientDisconnected;
    void Start();
    void Stop();
}

public interface IConfigService
{
    T GetValue<T>(string key, T defaultValue = default(T));
    void SetValue<T>(string key, T value);
    void Save();
}

public interface ISecurityService
{
    bool ValidateConnection(string ip);
    void BlockIP(string ip);
    bool IsBlocked(string ip);
}
```

#### MVVMæ¨¡å¼åˆ†ç¦»
```csharp
public class MainViewModel : INotifyPropertyChanged
{
    private readonly INetworkService _networkService;
    private readonly IConfigService _configService;
    private readonly ISecurityService _securityService;

    public ObservableCollection<ClientInfo> Clients { get; set; }
    public ICommand StartServerCommand { get; set; }
    public ICommand StopServerCommand { get; set; }

    public MainViewModel(INetworkService networkService,
                        IConfigService configService,
                        ISecurityService securityService)
    {
        _networkService = networkService;
        _configService = configService;
        _securityService = securityService;

        InitializeCommands();
        SubscribeToEvents();
    }
}
```

### 5. æ€§èƒ½ä¼˜åŒ–å»ºè®® âš¡

#### è¿æ¥æ± ç®¡ç†
```csharp
public class ConnectionPool : IDisposable
{
    private readonly ConcurrentQueue<AionConnection> _availableConnections;
    private readonly ConcurrentDictionary<int, AionConnection> _activeConnections;
    private readonly int _maxSize;
    private readonly object _lockObject = new object();

    public AionConnection GetConnection()
    {
        if (_availableConnections.TryDequeue(out AionConnection connection))
        {
            return connection;
        }

        return CreateNewConnection();
    }

    public void ReturnConnection(AionConnection connection)
    {
        if (_availableConnections.Count < _maxSize)
        {
            connection.Reset();
            _availableConnections.Enqueue(connection);
        }
        else
        {
            connection.Dispose();
        }
    }
}
```

#### é…ç½®ç¼“å­˜æœºåˆ¶
```csharp
public static class ConfigCache
{
    private static readonly ConcurrentDictionary<string, object> _cache
        = new ConcurrentDictionary<string, object>();
    private static readonly TimeSpan _cacheExpiry = TimeSpan.FromMinutes(5);

    public static T GetCached<T>(string key, Func<T> factory)
    {
        var cacheKey = $"{key}_{typeof(T).Name}";

        if (_cache.TryGetValue(cacheKey, out object cached))
        {
            var cacheItem = (CacheItem<T>)cached;
            if (DateTime.Now - cacheItem.Timestamp < _cacheExpiry)
            {
                return cacheItem.Value;
            }
        }

        var value = factory();
        _cache[cacheKey] = new CacheItem<T> { Value = value, Timestamp = DateTime.Now };
        return value;
    }

    private class CacheItem<T>
    {
        public T Value { get; set; }
        public DateTime Timestamp { get; set; }
    }
}
```

### 6. å®‰å…¨åŠ å›ºæªæ–½ ğŸ”

#### è¾“å…¥éªŒè¯
```csharp
public static class ValidationHelper
{
    public static bool IsValidIP(string ip)
    {
        return IPAddress.TryParse(ip, out _);
    }

    public static bool IsValidPort(string port)
    {
        return int.TryParse(port, out int p) && p > 0 && p <= 65535;
    }

    public static bool IsValidDatabaseConnectionString(string connectionString)
    {
        try
        {
            var builder = new DbConnectionStringBuilder
            {
                ConnectionString = connectionString
            };
            return builder.Count > 0;
        }
        catch
        {
            return false;
        }
    }

    public static string SanitizeInput(string input)
    {
        if (string.IsNullOrEmpty(input))
            return string.Empty;

        // ç§»é™¤å±é™©å­—ç¬¦
        return Regex.Replace(input, @"[<>""';\\x00-\\x1f\\x7f-\\x9f]", "");
    }
}
```

#### å®¡è®¡æ—¥å¿—
```csharp
public class SecurityAuditLogger
{
    private readonly ILogger _logger;

    public void LogConnectionAttempt(string ip, bool success)
    {
        _logger.Info($"Connection attempt from {ip}: {(success ? "SUCCESS" : "FAILED")}");
    }

    public void LogSecurityEvent(string eventType, string ip, string details)
    {
        _logger.Warn($"Security Event [{eventType}] from {ip}: {details}");
    }

    public void LogPrivilegedAction(string action, string user, string details)
    {
        _logger.Info($"Privileged Action [{action}] by {user}: {details}");
    }
}
```

## éƒ¨ç½²å’Œé…ç½®å»ºè®®

### 1. é…ç½®æ–‡ä»¶ç»“æ„
```
AionNetGate/
â”œâ”€â”€ é€šç”¨ç½‘å…³.exe
â”œâ”€â”€ Common.config          // é€šç”¨é…ç½®æ¨¡æ¿
â”œâ”€â”€ AionCommons.dll
â”œâ”€â”€ MySql.Data.dll
â”œâ”€â”€ BSE.Windows.Forms.dll
â””â”€â”€ configs/
    â”œâ”€â”€ network.config     // ç½‘ç»œé…ç½®
    â”œâ”€â”€ security.config    // å®‰å…¨é…ç½®
    â””â”€â”€ database.config    // æ•°æ®åº“é…ç½®
```

### 2. ç¯å¢ƒå˜é‡æ”¯æŒ
```csharp
public static class EnvironmentConfig
{
    public static string GetEnvironmentValue(string key, string defaultValue = "")
    {
        return Environment.GetEnvironmentVariable($"AION_NETGATE_{key}") ?? defaultValue;
    }

    public static void LoadEnvironmentConfig()
    {
        Config.server_ip = GetEnvironmentValue("SERVER_IP", Config.server_ip);
        Config.server_port = GetEnvironmentValue("SERVER_PORT", Config.server_port);
        // ... å…¶ä»–é…ç½®é¡¹
    }
}
```

### 3. æ—¥å¿—é…ç½®
```xml
<!-- log4net.config -->
<configuration>
  <log4net>
    <appender name="FileAppender" type="log4net.Appender.FileAppender">
      <file value="logs/netgate.log" />
      <appendToFile value="true" />
      <layout type="log4net.Layout.PatternLayout">
        <conversionPattern value="%date [%thread] %-5level %logger - %message%newline" />
      </layout>
    </appender>

    <appender name="SecurityAppender" type="log4net.Appender.FileAppender">
      <file value="logs/security.log" />
      <appendToFile value="true" />
      <layout type="log4net.Layout.PatternLayout">
        <conversionPattern value="%date [SECURITY] %message%newline" />
      </layout>
    </appender>

    <root>
      <level value="INFO" />
      <appender-ref ref="FileAppender" />
    </root>

    <logger name="Security">
      <level value="WARN" />
      <appender-ref ref="SecurityAppender" />
    </logger>
  </log4net>
</configuration>
```

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–æªæ–½ï¼ŒAionNetGateé¡¹ç›®åœ¨ä»¥ä¸‹æ–¹é¢å¾—åˆ°äº†æ˜¾è‘—æ”¹è¿›ï¼š

1. **å®‰å…¨æ€§**: ç§»é™¤äº†ç¡¬ç¼–ç URLå’Œæ³¨å†Œæœºåˆ¶ï¼Œæé«˜äº†ç³»ç»Ÿå®‰å…¨æ€§
2. **ç¨³å®šæ€§**: ä¿®å¤äº†Thread.Abortç­‰å±é™©æ“ä½œï¼Œæé«˜äº†ç³»ç»Ÿç¨³å®šæ€§
3. **å¯é…ç½®æ€§**: æä¾›äº†å¤–éƒ¨é…ç½®æ”¯æŒï¼Œä¾¿äºéƒ¨ç½²å’Œç»´æŠ¤
4. **å¯æ‰©å±•æ€§**: åˆ›å»ºäº†é…ç½®ç®¡ç†æ¡†æ¶ï¼Œæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•

å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½å‰©ä½™çš„ä¼˜åŒ–é¡¹ç›®ï¼Œç‰¹åˆ«å…³æ³¨åŠ å¯†æœºåˆ¶ã€å†…å­˜ç®¡ç†å’Œæ¶æ„é‡æ„æ–¹é¢çš„æ”¹è¿›ã€‚